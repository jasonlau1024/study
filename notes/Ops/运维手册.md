# Nginx

## 概述





## 安装

### Yum 安装

官方文档：http://nginx.org/en/linux_packages.html#stable

```shell
cat > /etc/yum.repos.d/nginx.repo <<"EOF"
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
EOF
yum install nginx -y
```



### 配置

#### server配置

```shell
# HTTP redirect
server {
	listen 80;
	server_name download.rmcex.vip;
	location / {
		return 301 https://download.rmcex.vip$request_uri;
	}
}
server {
	listen 443 ssl http2;

	server_name download.rmcex.vip;
	root /site/download.rmcex.vip/public;
	# SSL
	ssl_certificate /etc/nginx/ssl/download.rmcex.vip/fullchain.crt;
	ssl_certificate_key /etc/nginx/ssl/download.rmcex.vip/privkey.key;
	ssl_dhparam  /etc/nginx/ssl/dhparams.pem;
	# logs
	access_log /var/log/nginx/download.rmcex.vip.access.log;
	error_log /var/log/nginx/download.rmcex.vip.error.log warn;
	# index.html fallback
	location / {
		try_files $uri $uri/ /index.html;
	}
	# proxy
	location / {
		proxy_pass http://127.0.0.1:3000;
		proxy_http_version	1.1;
        proxy_cache_bypass	$http_upgrade;

        proxy_set_header Upgrade			$http_upgrade;
        proxy_set_header Connection 		"upgrade";
        proxy_set_header Host				$host;
        proxy_set_header X-Real-IP			$remote_addr;
        proxy_set_header X-Forwarded-For	$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto	$scheme;
        proxy_set_header X-Forwarded-Host	$host;
        proxy_set_header X-Forwarded-Port	$server_port;
	}
    # gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
}
```

#### http配置

```shell
... ...
worker_processes auto;
worker_rlimit_nofile 65535;
events {
	multi_accept on;
	worker_connections 65535;
}

http {
    ... ...
	charset utf-8;
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	types_hash_max_size 2048;
	client_max_body_size 16M;
	# SSL
	ssl_dhparam /etc/nginx/ssl/dhparam.pem;
	ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
	ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ... ...
}

## 生成证书
mkdir /etc/nginx/ssl
ssl_dhparam /etc/nginx/ssl/dhparam.pem
openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
```



## 维护

### nginx 配置示例

#### Gzip 压缩配置：

```shell
http {
.......
    gzip  on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_http_version 1.1;
    gzip_comp_level 9;
    gzip_types       text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php application/javascript application/json;
    gzip_disable "MSIE [1-6]\.";
    gzip_vary on;
}
```



### 报错及处理

#### "413 Request Entity Too Large"

分析：上传文件大小被限制了，nginx默认上传文件的大小限制是1M，修改加大上传文件大小限制即可。

在`http{}`或`server、location`中加入`client_max_body_size XXm`

reload 即可





开启压缩影响：

压缩前：

![1575973366166](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575973366166.png)



### 安全优化建议

#### 开启访问日志

开启日志有助于发生安全事件后回溯分析整个事件的原因及定位攻击者。

`access_log /var/log/nginx/access.log combined;`

#### 隐藏版本号

`Server_tokens off;`

#### 禁用非必要的请求方法

`trace` 请求用于网络诊断，会暴露信息，只允许 GET、HEAD、POST 请求，其他请求直接返回444状态码 （444是 Nginx 定义的响应状态码，会立即断开连接，没有响应正文，TRACE 请求 Nginx 内置405拒绝）。     

`if ($request_method !~ ^(GET|HEAD|POST)$ ) { return 444; }`



# PHP



## 维护



### 配合优化



#### php-fpm 超时设置

默认配置：

php-fpm: `request_terminate_timeout = 0`

php.ini: `max_execution_time = 30`

`max_execution_time`：设置脚本被解析器中止之前允许的最大执行时间。

`request_terminate_timeout`：由于某种原因当`max_execution_time`无法终止脚本的时，超过这个时间会把这个php-fpm请求干掉。

注：`max_execution_time`指的是脚本的执行时间；

`request_terminate_timeout`指的是从http请求开始计算，包括等待响应等。

### 文件权限管理

1. php-fpm配置用户跟nignx保持一致

2. 所有文件属主属组跟php-fpm和nginx定义的用户保持一致

3. 目录权限755，文件权限644

   目录：`find /var/www/html/ -type d -exec chmod 755 {} \;`

   文件：`find /var/www/html/ -type f -exec chmod 644 {} \;`

   补充：部分需要执行权限的文件可以设置为755.



### 安全优化建议

#### 控制脚本访问权限

PHP 默认配置允许 PHP 脚本程序访问服务器上的任意文件，为避免 PHP 脚本访问不该访问的文件，从一定程度上限制了 PHP 木马的危害，需设置 PHP 只能访问网站目录或者其他必须可访问的目录。

```shell
## 配置文件php.ini
open_basedir=/var/www/:/var/lib/php/:/tmp/
## 多个目录通过冒号隔开
```

#### 隐藏 PHP 版本信息

攻击者在信息收集时候无法判断程序版本，增加防御系数。

```shell
## 配置文件 php.ini
expose_php =off
```

#### 禁用 PHP 危险函数

Web 木马程序通常利用 PHP 的特殊函数执行系统命令，查询任意目录文件，增加修改删除文件等。PHP 木马程序常使用的函数为： dl, eval, assert, exec, popen, system, passthru, shell_exec 等。

```shell
## 配置文件 php.ini
disable_functions= dl,eval,assert,exec,passthru,popen,proc_open,shell_exec,system,phpinfo,assert
```

#### 开启 magic_quotes_gpc

`magicquotesgpc` 会把引用的数据中包含单引号 `'`和双引号 `"` 以及反斜线 `\` 自动加上反斜线，自动转译符号，确保数据操作的正确运行，`magicquotesgpc` 的设定值将会影响通过 `Get/Post/Cookies` 获得的数据，可以有效的防止 SQL 注入漏洞。

```shell
## 配置文件 php.ini
magicquotesgpc = On*
```

#### 其它参考配置

- 开启 magic_quotes_runtime，对文件或者数据库中取出的数据过滤，能很好的解决二次注入漏洞。
  `magic_quotes_runtime = On`
- 关闭错误信息提示：
  `display_errors = off`
  `display_startup_errors = off`
- 开启错误日志记录，闭 display_errors 后能够把错误信息记录下来，便于查找服务器运行的原因,同时也要设置错误日志存放的目录，建议跟 webserver 的日志放在一起。
  `log_errors = On`
  `error_log = /usr/local/apache2/logs/php_error.log`
- 不允许调用 dl：
  `enable_dl = off`
- 关闭远程文件，允许访问 URL 远程资源使得 PHP 应用程序的漏洞变得更加容易被利用，PHP  脚本若存在远程文件包含漏洞可以让攻击者直接获取网站权限及上传 Web 木马，一般会在 PHP  配置文件中关闭该功能，若需要访问远程服务器建议采用其他方式，如 libcurl 库：
  `allow_url_fopen =  off`
  `allow_url_include = off`
- 开启 http only：
  `session.cookie_httponly = 1`
  `cookie domain`
- 开启 https secure：
  `session.cookie_secure = 1`
- 适当的 PHP redirects：
  `cgi.force_redirect = 0`
- SQL 的安全模式：
  `sql.safe_mode = on`

#### .htaccess 和 .user.ini 文件

.htaccess是伪静态环境配置文件，用于lamp。
.user.ini是lnmp文件，里面放的是你网站的文件夹路径地址。目的是防止跨目录访问和文件跨目录读取.
配置 放在根目录 .user.ini

```shell
cat .user.ini
open_basedir=/www/aaa/:/tmp/:/proc/
```

实例：没加.user.ini 可直接访问根目录的文件

```shell
# 测试代码
cat test.php
<?php
$dir = dirname(__FILE__);
echo " <pre>";
print_r($dir);
$file = scandir('/');
echo " <pre>";
print_r($file);
?>
# 添加之后就读取不到了
```

详细关于`.user.ini`文件说明可参考：https://segmentfault.com/a/1190000011552335?utm_source=tag-newest





# Tomcat







## 维护

### 安全优化

***启动安全模式：***

为了限制脚本的访问权限，防范 webshell 木马，建议启动时增加安全参数启动。

`Tomcat/bin/startup.sh –security`

***删除 Tomcat 默认页面：***

删除`tomcat/webapps/`目录下的所有文件及目录。

`Tomcat/webapps/docs/`
`Tomcat/webapps/examples/`
`Tomcat/webapps/host-manager/`
`Tomcat/webapps/manager/`
`Tomcat/webapps/ROOT/`

删除 Tomcat 的 admin 控制台软件:删除`{Tomcat安装目录}\webapps`下`admin.xml`文件。
删除 Tomcat 的 Manager 控制台软件:删除`{Tomcat安装目录}\webapps`下`manager.xml`文件。              

***删除 jspx 文件解析：***

Tomcat 默认是可以解析 jspx 文件格式的后缀，解析 jspx 给服务器带来了极大的安全风险，若不需要使用 jspx 文件，建议删除对 jspx 的解析。修改 `conf/web.xml` 文件。

`# <url-pattern>*.jspx</url-pattern>	# 注释掉`

***禁止显示错误信息：***

Tomcat 在程序执行失败时会有错误信息提示，可能泄漏服务器的敏感信息，需要关闭错误提示信息。可以通过指定错误页面的方式不将错误信息显示给用户，修改`tomcat/conf/web.xml`,增加如下配置项：

```shell
<error-page>
<error-code>500</error-code>
<location>/500.jsp</location>
</error-page>
```







# Redis

## 概述



## 安装





# SQLite3

## 概述

## 安装

centos7 默认已经安装了SQLite3。

## 维护

### 管理指令

`sqlite3 dbfile.db` （创建）连接数据库。

`.databases` 显示所有数据库。

`.tables` 显示数据库中所有表。

`.schema TableName` 显示表结构，等同MySQL的`show create table TableName ` 。

```shell
## 导出当前数据库的 SQL 语句
> .output /path/to/file.sql
> .dump [TableName]  ## 默认整个库
# 或
sqlite3 dbfile.db .dump > test.sql
## 导入 SQL 语句
> .import /path/to/file.sql
# 或
sqlite3 dbfile.db < /path/to/file.sql
```

`delete from TableName;`  清空表数据







# Docker

## 概述



## 安装

```shell
## 更新yum包
$ sudo yum update -y
## 卸载旧版本
$ sudo yum remove docker docker-common docker-selinux docker-engine
## 安装需要的软件包 （yum -util 提供 yum-config-manager 功能；另外两个是 devicemapper 驱动的依赖）
$ sudo yum install yum-utils device-mapper-persistent-data lvm2 -y
## 设置 Yum 源
$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
## 查看仓库中的所有 docker 版本
$ sudo yum list docker-ce --showduplicates | sort -r
## 安装指定版本  yum install <FQPN>
$ sudo yum install docker-ce-19.03.1
$ sudo yum install docker-ce -y
## 启动并加入开机自启动
$ sudo systemctl start docker
$ sudo systemctl enable docker
## 验证是否安装成功
$ sudo docker version
```



















# Openvpn

## 概述

Openvpn 是一个非常简单易用的开源VPN，可在Windows、Linux/BSD等各大平台下运行，其核心技术包括虚拟网卡和SSL协议。



## 安装

### Yum 安装

#### 安装 epel 源 easy-rsa openvpn

```shell
yum install -y epel-release 
yum update -y
yum install -y openssl lzo pam openssl-devel lzo-devel pam-devel
yum install -y easy-rsa
yum install -y openvpn
```

#### 生成证书

```shell
## 初始化 PKI
cd ~
/usr/share/easy-rsa/3/easyrsa init-pki
## 生成 CA 证书
/usr/share/easy-rsa/3/easyrsa build-ca nopass
## 生成交互秘钥
/usr/share/easy-rsa/3/easyrsa gen-dh
## 生成服务端密钥
/usr/share/easy-rsa/3/easyrsa build-server-full vpn-server nopass
## 生成客户端密钥
/usr/share/easy-rsa/3/easyrsa build-client-full vpn-client-01 nopass
## 多个客户端可生成多个客户端秘钥
/usr/share/easy-rsa/3/easyrsa build-client-full vpn-client-02 nopass
## 生成证书交互列表，如果不需要 crl-verify 则可以跳过
/usr/share/easy-rsa/3/easyrsa gen-crl
## 生成共享密钥，如果不开启 tls-auth 则可以跳过
openvpn --genkey --secret pki/ta.key
## 拷贝所以生成的证书到 /etc/openvpn/ 目录
```

#### 服务端配置

> 详细配置可参考官方文档：https://openvpn.net/community-resources/how-to/

```shell
cp -R /usr/share/easy-rsa/ /etc/openvpn/
cp /usr/share/doc/openvpn-2.4.8/sample/sample-config-files/server.conf /etc/openvpn/server/
cp -r /usr/share/doc/easy-rsa-3.0.6/vars.example /etc/openvpn/easy-rsa/3.0/vars
cat /etc/openvpn/server.conf
port 1194
proto udp
dev tun
ca /etc/openvpn/easy-rsa/3.0/pki/ca.crt
cert /etc/openvpn/easy-rsa/3.0.3/pki/issued/vpnserver.crt
key /etc/openvpn/easy-rsa/3.0.3/pki/private/vpnserver.key
dh /etc/openvpn/easy-rsa/3.0/pki/dh.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 114.114.114.114"
push "dhcp-option DNS 8.8.8.8"
keepalive 10 120
tls-auth ta.key 0
cipher AES-256-CBC
comp-lzo
max-clients 100
user openvpn
group openvpn
persist-key
persist-tun
status openvpn-status.log
log-append openvpn.log
verb 3
mute 20


dh dh2048.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
keepalive 10 120
tls-auth ta.key 0 # This file is secret
cipher AES-256-CBC
persist-key
persist-tun
status openvpn-status.log
verb 3
explicit-exit-notify 1
```

### Openvpn-server配置说明

```shell
;local 10.10.200.30  ## 默认情况下监听本服务器上所有IP
port 1194  ## 默认监控端口，注意防火墙设置

# 使用的网络协议 TCP/UDP
;proto tcp
proto udp

# tap为以太网通道，桥接模式
# tun为路由IP通道，容易控制
dev tap
;dev tun

# 通常只在Windows下设置，配置多个隧道时指定适配器名称，如：MyTap
;dev-node MyTap

# 服务端和客户端都将使用相同的CA证书
# 服务端和客户端指定各自的证书和密钥
# 服务端和客户端的证书必须使用相同的 Common Name
# 可以使用以配置文件开始为根的相对路径，也可以使用绝对路径
ca /etc/openvpn/easy-rsa/3.0/pki/ca.crt
cert /etc/openvpn/easy-rsa/3.0.3/pki/issued/server.crt
key /etc/openvpn/easy-rsa/3.0.3/pki/private/server.key

# 指定迪菲·赫尔曼参数
# 参数生成命令：openssl dhparam -out dh2048.pem 2048
dh dh2048.pem

# 子网网络拓扑
# Windows客户端且版本低于2.0.9才需要设置
;topology subnet

# 为客户端分配IP地址的VPN的网段，不能和双方的内网网段重复
server 10.8.0.0 255.255.255.0

# 客户端和VIP的对应表，当客户端重连时仍然分配原IP
ifconfig-pool-persist ipp.txt

# 仅针对以太网桥接模式
# 首先，将以太网网卡和TAP进行桥接
# 然后，设置桥接接口的IP地址、子网掩码
# 最后，指定用于分配给客户端的子网的IP范围
;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100

# 仅针对使用DHCP代理的以太网桥接模式
# 仅用于客户端，并且该客户端的TAP适配器需要绑定到一个DHCP客户端上
# 首先，将以太网网卡和TAP进行桥接
;server-bridge

# 推送路由信息到客户端，使客户端能够连接到服务器背后的其他私有子网
;push "route 192.168.10.0 255.255.255.0"
;push "route 192.168.20.0 255.255.255.0"

# 为特定的客户端指定IP，或使客户端背后子网也可以连接到VPN
# 举例，首先取消如下注释：
;client-config-dir ccd
;ifconfig-push 10.9.0.1 10.9.0.2
# 然后在ccd目录中添加以 Common Name 命名的文件，其内容是：
;route 192.168.40.128 255.255.255.248

# 为不同群组的客户端启用不同的防火墙访问策略
# 关于learn-address脚本的更多信息请参考官方手册页面
;learn-address ./script

# 使客户端所有的流量都通过VPN传输，请注意服务端的DHCP设置
push "redirect-gateway def1 bypass-dhcp"

# 用OpenVPN的DHCP功能为客户端提供指定的DNS
push "dhcp-option DNS 114.114.114.114"
push "dhcp-option DNS 8.8.8.8"

# 允许客户端之间互相访问
;client-to-client

# 使具有相同 Common Name 的客户端都可以登陆
# 建议每个客户端都有独立的证书和私钥
;duplicate-cn

# 每10秒ping一次，如果120秒没有回应则认为远程连接已关闭
keepalive 10 120

# 服务端和客户端都需要有该密钥的一个拷贝
# 第二个参数在服务器端应该为'0'，在客户端应该为'1'
tls-auth ta.key 0

# 加密算法
cipher AES-256-CBC

# 在VPN连接上启用压缩并推送至客户端
# 仅2.4以上版本
;compress lz4-v2
;push "compress lz4-v2"

# 在VPN连接上启用压缩，服务端和客户端都必须采用相同配置
comp-lzo

# 最大客户端连接数
max-clients 100

# 降低OpenVPN守护进程的权限
user nobody
group nobody

# 保障重启时仍能保留一些状态
persist-key
persist-tun

# 输出短日志,每分钟刷新一次,以显示当前的客户端
status openvpn-status.log

# 记录日志，重启openvpn后覆盖原log文件
;log openvpn.log

# 记录日志，新日志信息追加到文件最后
log-append openvpn.log

# 日志要记录的级别，值越大日志越详细：
# 0 只记录错误信息
# 4 能记录普通的信息
# 5/6 在连接出现问题时能帮助调试
# 9 显示所有信息，包括包头信息等 
verb 3

# 相同信息的记录次数，连续出现20条后不再记录到日志中
mute 20

# 当服务端重启后，使客户端能自动重连
explicit-exit-notify 1
```

### Openvpn-client 配置说明

```shell
# 指定为客户端
client

;dev tap
dev tun

;dev-node MyTap

;proto tcp
proto udp

# 指定服务器(主机名或IP)以及端口号，可设置多个VPN服务器
remote vpnserver 1194
;remote 10.10.200.32 1194

# 设置多个VPN服务器时，采用随机连接模式，否则按先后顺序(非轮询)
;remote-random

# 启用自动重连，适合不稳定的网络环境
resolv-retry infinite

# 客户端默认不需要绑定本机特定的端口号
nobind

;user nobody
;group nobody

persist-key
persist-tun

# 通过HTTP代理来连接VPN服务器
# 连接失败时自动重试
# 指定代理服务器的IP和端口
;http-proxy-retry
;http-proxy [proxy server] [proxy port]

# 适用于无线网络，忽略重复数据包的警告信息
;mute-replay-warnings

ca ca.crt
cert client.crt
key client.key

# 通过检查证书的nsCertType字段是否与服务端相同，默认为server
# 这是预防潜在攻击的一种重要措施
# 可以通过./easyrsa build-key-server 脚本实现
ns-cert-type server

;tls-auth ta.key 1

;cipher AES-256-CBC

comp-lzo

# 可不与服务端相同
verb 3

;mute 20
```

## 维护

### 撤销证书

```shell
## 先删除文件
rm -rf /etc/openvpn/easy-rsa/3.0/pki/reqs/vpnserver.req
rm -rf /etc/openvpn/easy-rsa/3.0/pki/private/vpnserver.key
## 后撤销证书
cd /etc/openvpn/easy-rsa/3.0
./easyrsa revoke server
./easyrsa gen-crl
## 重启 openvpn 即可
```















# JumpServer

## 概述

Jumpserver 是全球首款完全开源的堡垒机，使用 GNU GPL v2.0 开源协议，是符合 4A 机制的运维安全审计系统。

Jumpserver 使用 Python / Django 进行开发，遵循 Web 2.0 规范，配备了业界领先的 Web Terminal 方案，交互界面美观、用户体验好。

Jumpserver 采纳分布式架构，支持多机房跨区域部署，支持横向扩展，无资产数量及并发限制。

***核心功能：***

- 身份验证 Authentication
  - 登录认证
    - 资源统一登录和认证
    - LDAP 认证
    - 支持 OpenID，实现单点登录
  - 多因子认证
    - MFA（Google Authenticator）

- 账号管理 Account
  - 集中账号管理
    - 管理用户管理
    - 系统用户管理
  - 统一密码管理
    - 资产密码托管
    - 自动生成密码
    - 密码自动推送
    - 密码过期设置
  - 批量密码变更(X-PACK)
  - 多云环境的资产纳管(X-PACK)



## 安装

### 安装说明

***组件说明：***

- **Jumpserver：**管理后台, 管理员可以通过 Web 页面进行资产管理、用户管理、资产授权等操作, 用户可以通过 Web 页面进行资产登录, 文件管理等操作。
- **coco：**SSH Server 和 Web Terminal Server 。用户可以使用自己的账户通过 SSH 或者 Web Terminal 访问 SSH 协议和 Telnet 协议资产。
- **Luna：**Web Terminal Server 前端页面, 用户使用 Web Terminal 方式登录所需要的组件。
- **Guacamole：**RDP 协议和 VNC 协议资产组件, 用户可以通过 Web Terminal 来连接 RDP 协议和 VNC 协议资产。

***端口说明：***

| Protocol | Server name | Port       | 配置文件                        |
| -------- | ----------- | ---------- | ------------------------------- |
| TCP      | Jumpserver  | 8080       | jumpserver/config.yml           |
| TCP      | coco        | 2222, 5000 | coco/config.yml                 |
| TCP      | Guacamole   | 8081       | /config/tomcat9/conf/server.xml |
| TCP      | Db          | 3306       |                                 |
| TCP      | Redis       | 6379       |                                 |
| TCP      | Nginx       | 80         |                                 |

***安装环境：***

```shell
sudo yum update -y
## 防火墙配置
$ sudo firewall-cmd --zone=public --add-port=80/tcp --permanent
$ sudo firewall-cmd --zone=public --add-port=2222/tcp --permanent
$ sudo firewall-cmd --reload
## 关闭 Selinux
$ sudo setenforce 0
$ sudo sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
## 修改字符集，否则可能报 input/output error的问题，因为日志里打印了中文
$ sudo localedef -c -f UTF-8 -i zh_CN zh_CN.UTF-8
$ export LC_ALL=zh_CN.UTF-8
$ sudo sh -c 'echo 'LANG="zh_CN.UTF-8"' > /etc/lcale.conf'
```

### 一站式安装

***安装Redis:***

做 cache 和 celery broke

```shell
$ sudo yum -y install redis
$ sudo systemctl enable redis
$ sudo systemctl start redis
```

***安装MariaDB：***

还可支持sqlite3, mysql, postgres等

```shell
$ sudo yum -y install mariadb mariadb-devel mariadb-server MariaDB-shared
$ sudo systemctl enable mariadb
$ sudo systemctl start mariadb
$ DB_PASSWORD=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 24`
$ echo -e "\033[31m 你的数据库密码是 $DB_PASSWORD \033[0m"
  Bef1Rro2s4fcZetuyToRfhyI
$ mysql -uroot -e "create database jumpserver default charset 'utf8'; grant all on jumpserver.* to 'jumpserver'@'127.0.0.1' identified by '$DB_PASSWORD'; flush privileges;"
```

***安装并配置nginx：***

作为代理服务器整合 Jumpserver 与各个组件



### Docker 快速安装





```shell
# 生成随机加密秘钥, 勿外泄
$ if [ "$SECRET_KEY" = "" ]; then SECRET_KEY=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 50`; echo "SECRET_KEY=$SECRET_KEY" >> ~/.bashrc; echo $SECRET_KEY; else echo $SECRET_KEY; fi



$ if [ "$BOOTSTRAP_TOKEN" = "" ]; then BOOTSTRAP_TOKEN=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`; echo "BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN" >> ~/.bashrc; echo $BOOTSTRAP_TOKEN; else echo $BOOTSTRAP_TOKEN; fi

docker run --name jms_all -d \
    -v /data/jumpserver/media:/opt/jumpserver/data/media \
    -v /data/jumpserver/mysql:/var/lib/mysql \
    -v /data/jumpserver/conf.d:/var/nginx/conf.d
    -p 6680:80 \
    -p 6622:2222 \
    -e SECRET_KEY=YXt4AtOKuz1db4RFB4jH26xxwopc007IHwljozDKgN2bvo15yf \
    -e BOOTSTRAP_TOKEN=soJBEZX3DD0T9c3y \
    jumpserver/jms_all:latest
```



## 维护

### web 使用

#### 批量执行切换身份执行命令

如：远程更新系统时区

`sudo su -c "ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime"`

远程执行多条指令：

```shell
sudo su -c "echo '* soft nofile 655350' >>/etc/security/limits.conf;\
echo '* hard nofile 655350' >>/etc/security/limits.conf;\
echo '* hard nproc 655350' >>/etc/security/limits.conf;\
echo '* soft nproc 655350' >>/etc/security/limits.conf
"
```



# Jenkins

## 概述



## 安装

### Yum 安装

```shell
## 安装 java
yum search java|grep jdk
yum install java-1.8.0-openjdk
java -version

sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
sudo yum install jenkins -y
## 修改配置文件
sed -i 's#JENKINS_PORT="8080"#JENKINS_PORT="8180"#g' /etc/sysconfig/jenkins
sed -i 's#JENKINS_LISTEN_ADDRESS=""#JENKINS_LISTEN_ADDRESS="127.0.0.1"#g' /etc/sysconfig/jenkins
sudo systemctl start jenkins
sudo systemctl enable jenkins
## 配置nginx
# 安装 【略】
## 说明在使用别的端口时需要做proxy_redirect跳转
proxy_redirect  https://jenkins.futurebank.cc  https://jenkins.futurebank.cc:8443;
```

### 离线安装插件

1. 手动下载插件HPI包

   下载链接可以通过在线安装失败日志获取，或在 <http://updates.jenkins-ci.org/download/plugins/> 找到对应的插件下载

2. 安装：插件管理 --> 上传插件`hpi`文件 --> 等待安装完成，重启Jenkins

### 用户管理

插件：

- **Role-based Authorization Strategy** 基于角色的权限管理

#### 不同的用户管理不同的项目

1. 系统管理 --> 全局安全配置 --> 选择"Manage and Assign Roles"

   ![1576547897084](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576547897084.png)

2. 新建用户（如：test/develop/product）

   系统管理 --> 管理用户 --> 新建用户

   ![1576548543418](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576548543418.png)

3. 配置权限

   系统管理 --> Manage and Assign Roles

   注：一个用户想要进行操作必须要有两种角色，一种是全局，一种是`Project`

   ![1576548163447](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576548163447.png)

   1）"Manage Roles:"添加全局角色，创建三种角色，分配全局读权限

   ![1576548866625](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576548866625.png)

   2）"Assign Roles:"分配角色，将用户分为3种属性身份，授予全局角色身份

   ![1576549097700](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576549097700.png)

   3）在"Manage Roles" 的 "Project roles"创建项目角色

   ![1576748205319](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576748205319.png)

   4）给用户分配项目权限"Assign Roles"

   ![1576753345052](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576753345052.png)



## 维护

### Gitlab 自动触发构建以及钉钉通知

场景：代码提交到 `gitlab` 上，`gitlab` 分支变动触发 Jenkins 构建，发布到目标服务器上。更新完成后，通过钉钉机器人提供的`webhook`在钉钉群通知，并打印本次提交者以及提交的内容。

#### 配置 GitLab 触发 Jenkins 自动构建

插件：`GitLab` 和 `GitLab Hook`

特别说明：

> 网上有很多教程，都是去 Gitlab 的用户设置里面配置 Access Token，然后再将 Token 配置到 Jenkins 的系统配置中 GitLab 项里面，其实根本就不需要。

1. Jenkins 配置 GitLab 账户来拉取代码。

   ![1576830940337](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576830940337.png)

   ![1576830865404](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576830865404.png)

2. GitLab 通过配置 Jenkins 提供的 Token 触发 Jenkins 构建。

   **Jenkins配置：**

   1）新建一个自由风格的任务

   2）配置 Git 地址

   ![1576832327439](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576832327439.png)

   3）配置触发器

   ![1576833757706](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576833757706.png)

   "高级"选项卡：

   ![1576834048276](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576834048276.png)

   4）添加构建操作

   ![1576834666551](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576834666551.png)

   **GitLab 配置：**















# NFS

## 概述

### 简介

NFS（Network File System）即网络文件系统，它允许网络中的计算机之间通过网络共享资源。将NFS主机分享的目录，挂载到本地客户端当中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，在客户端端看起来，就像访问本地文件一样。

RPC，基于C/S模型。程序可以使用这个协议请求网络中另一台计算机上某程序的服务而不需知道网络细节，甚至可以请求对方的系统调用。

对于Linux而言，文件系统是在内核空间实现的，即文件系统比如ext3、ext4等是在Kernel启动时，以内核模块的身份加载运行的。

### NFS 优缺点

**优点：**

1. 简单易上手。
2. NFS文件系统内数据是在文件系统之上的，即数据是能看得见的。
3. 部署快速，维护简单方便，且可控，满足需求得就是最好的。
4. 可靠，从软件层面上看。数据可靠性高，经久耐用。数据是文件系统之上的
5. 服务非常稳定。

**缺点：**

1. 存在单点故障，如NFSserver宕机，所有客户端都不能访问共享目录。（可考虑HA方案）
2. 在大数据高并发的场合，NFS效率低，性能有限。
3. 客户端认证是基于IP和主机名的，权限要根据ID识别，安全性一般。
4. NFS数据是明文的，NFS本身不对数据完整性作验证。
5. 多台客户机器挂载一个NFS服务器，维护比较麻烦。

### 工作原理

NFS本身的服务并没有提供数据传递的协议，而是通过使用RPC（远程过程调用 Remote Procedure Call）来实现。当NFS启动后，会随机的使用一些端口，NFS就会向RPC去注册这些端口。RPC就会记录下这些端口，RPC会开启111端口。通过client端和sever端端口的连接来进行数据的传输。因此，在启动nfs之前，要确保rpc服务正在运行。

![img](https://hcdn1.luffycity.com/data/linux-book/img/15.png)

当访问程序通过NFS客户端向NFS服务端存取文件时，其请求数据流程大致如下：

1）首先用户访问网站程序，由程序在`NFS Clinet`发出存取NFS文件的请求，这时`NFS Client`的`rpcbind`服务就会通过网络向`NFS Server`的`rpcbind`的111端口发出NFS文件存取功能的询问请求；

2）`NFS Server`的`rpcbind`找到对应的已注册的NFS端口后，通知`NFS Clinet`的`rpcbind`。此时`NFS Client`获取到正确的端口，并与`NFS daemon`联机存取数据。

3）`NFS Client`把数据存取成功后，返回给前端访问程序，告知给用户存取结果，作为网站用户，就完成了一次存取操作。

**NFS 与 RPC 之间的关系：**

NFS的各项功能都需要向RPC服务注册，所以只有RPC服务才能获取到NFS服务的各项功能对应的端口号、PID、NFS在主机所监听的IP等信息，而NFS客户端也只能通过向RPC服务询问才能找到正确的端口。

**启动的服务组件说明：**

```shell
rpc：远程过程调用协议，是实现本地调用远程主机实现系统调用的协议。
portmapper：负责分配rpc server的端口，并在client端请求时，负责响应目的rpc server端口返回给client端，工作在tcp与udp的111端口上。
rpc.mountd：是nfs服务的认证服务的守护进程，client在收到返回的真正端口时，就会去连接mountd，认证取得令牌。
nfsd：nfs的守护进程，负责接收到用户的调用请求后与内核发出请求并得到调用结果响应给用户，工作在tcp和udp的2049端口。
rpc.lockd：文件锁定，避免多个用户同时修改一个文件。
rpc.statd：文件一致性校验，检查修复多个用户同时修改一个文件造成的文件损坏。同lockd需要服务端和客户端同时运行才能生效。
rpc.idmapd：是NFS的一个程序，用来负责远程client端创建文件后的权限问题。
rpc.rquotad：用用于实现磁盘配额，当client端挂载nfs后可以限制磁盘空间的大小。
```

## 安装

nfs 程序包：`nfs-utils`

rpcbind 程序包：`rpcbind`

### 安装 nfs-util 和 rpcbind

```shell
## 客户端服务端都需安装
## 启动服务需要先启动rpcbind然后再启动NFS
yum install nfs-utils rpcbind -y
systemctl start rpcbind
systemctl start nfs
systemctl enable rpcbind
systemctl enable nfs
```

### 创建共享目录

```shell
## 服务端
mkdir -p /mnt/backup
echo '/mnt/backup *(rw,async,no_root_squash,no_subtree_check)' >> /etc/exports
exportfs -a
## 服务端
mkdir /backup
mount -t nfs server_ip:/mnt/backup /backup
echo "echo "server_ip:/mnt/backup /backup nfs rw,tcp,intr 0 1" >> /etc/fstab"
```

### /etc/exports 配置说明

示例：`/export 172.16.1.34(rw,sync,no_root_squash) *(ro)`

```shell
rw|ro：读写|只读 权限； 

sync：（同步）资料同步写入存储器中。 
async：（异步）资料会先暂时存放在内存中，不会直接写入硬盘。 提升写入效率，宕机丢失风险。

no_root_squash：登入到NFS主机的用户如果是ROOT用户，它对该共享目录具有root权限，此参数很不安全，建议不要使用。 
root_squash：如果是root压缩为匿名用户（默认nfsnobody）。
all_squash：所有访问NFSserver共享目录的用户身份重新设定为指定匿名用户。 

anonuid|anongid：指定匿名用户的UID|UID,此ID必须存在于/etc/passwd中。 

insecure：允许从这台机器过来的非授权访问。
```

注：使用匿名用户，客户端和服务端都必须有该用户且UID和GID保持一致。

### /etc/fstab 配置说明

示例：`server_ip:/export  /mnt/export  nfs  rw,tcp,intr  0 1`

```shell
第1列是需要挂载的文件系统或存储设备
第2列是挂载点
第3列指定文件系统或分区的类型
第4列为挂载选项,可参考man mount
   auto: 系统自动挂载，fstab默认就是这个选项
   ro: read-only
   rw: read-write
   defaults: rw, suid, dev, exec, auto, nouser, and async. 
第5列为dump选项，设置是否让备份程序dump备份文件系统，0为忽略，1为备份。
第6列为fsck选项，告诉fsck程序以什么顺序检查文件系统，0为忽略。 
```

## 维护

### 故障排查

客户端&服务端连接异常

```shell
## 服务端自检
showmount -e server_ip
## 客户端检查
showmount -e server_ip
mount|umount  ## 挂载信息科查看/proc/mounts文件
## 平滑重启 nfs
systemctl reload nfs
## 重载所有挂载点
exportfs -a
```

挂载报错异常：

`umount:/mnt:device is busy` 需要退出挂载目录才能执行卸载。

`NFS server`宕机，需要强制卸载，`umount -lf /mnt`

### 优化

**客户端挂载参数优化：**

`mount -t nfs -o nosuid,noexec,nodev,noatime,nodiratime,rsize=131071,wsize=131072 10.0.0.7:/data/ /mnt  ## 兼顾安全性能`

**系统内核优化：**

```shell
cat >> /etc/sysctl.conf << EOF
net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
EOF
```









# Zabbix

## 概述



## 安装

### Yum 安装

zabbix 4.4 新特性：https://www.zabbix.com/documentation/4.4/manual/introduction/whatsnew440

zabbix4 部署参考文档：<https://www.zabbix.com/download?zabbix=4.0&os_distribution=centos&os_version=7&db=mysql>

***安装 php***

```shell
## yum 安装
yum install -y php php-gd php-mysql php-fpm php-mbstring php-xml
## 编辑 php.ini 文件
sed -i 's#post_max_size = 8M#post_max_size = 16M#g' /etc/php.ini
sed -i 's#max_execution_time = 30#max_execution_time = 300#g' /etc/php.ini
sed -i 's#max_input_time = 60#max_input_time = 300#g' /etc/php.ini
# date.timezone = Asia/Shanghai
systemctl start php-fpm
systemctl enable php-fpm
```

***安装nginx***

```shell
## 安装 略
## 配置
#server {
#   listen 80;
#   listen [::]:80;
#   server_name zabbix.futurebank.cc;
#   location / {
#       return 301 https://zabbix.futurebank.cc$request_uri;
#   }
#}
server {
    listen 8443 ssl http2;
    listen [::]:8443 ssl http2;
    server_name zabbix.futurebank.cc;
    # SSL
    ssl_certificate /etc/letsencrypt/live/zabbix.futurebank.cc/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/zabbix.futurebank.cc/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/zabbix.futurebank.cc/chain.pem;
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    access_log /var/log/nginx/zabbix.futurebank.cc.access.log;
    error_log    /var/log/nginx/zabbix.futurebank.cc.error.log;

    location / {
        root /usr/share/zabbix;
        index index.php;
    }
    location ~ \.php$ {
        root           /usr/share/zabbix;
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
        fastcgi_param SCRIPT_FILENAME /usr/share/zabbix$fastcgi_script_name;
        include        fastcgi_params;
        fastcgi_buffers 8 128k;
        fastcgi_buffer_size 128k;
    }
}
```

***安装MySQL：***

```shell
## 安装 略
grant all privileges on zabbix.* to zabbix@'%' identified by 'Zabbix@123';
FLUSH PRIVILEGES;
```

***安装zabbix：***

```shell
rpm -Uvh https://repo.zabbix.com/zabbix/4.4/rhel/7/x86_64/zabbix-release-4.4-1.el7.noarch.rpm
yum clean all
yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent
## 修改配置文件
vim /etc/zabbix/zabbix_server.conf
#修改内容如下:
DBHost=localhost
DBName=zabbix
DBUser=zabbix
DBPassword=Zabbix@123
## 导入数据
/usr/share/doc/zabbix-server-mysql-xxx/create.sql.gz
## web 默认登录用户密码：admin/zabbix
```



#### Agent 端安装

下载agent 对应版本的rpm包。

下载地址：

`rpm -Uvh https://repo.zabbix.com/zabbix/4.4/rhel/7/x86_64/zabbix-agent-4.4.2-1.el7.x86_64.rpm`

yum install zabbix-agent -y

修改配置文件：

```shell
sed -i 's#ServerActive=127.0.0.1#ServerActive=172.31.215.230#g' /etc/zabbix/zabbix_agentd.conf
sed -i 's#Hostname=Zabbix server#Hostname=Jumpserver#g' /etc/zabbix/zabbix_agentd.conf
sed -i 's#Server=127.0.0.1#Server=172.31.215.230#g' /etc/zabbix/zabbix_agentd.conf
```

补充Ubuntu:

```shell
wget http://repo.zabbix.com/zabbix/4.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.4-1%2Bxenial_all.deb
dpkg -i zabbix-release_4.4-1+xenial_all.deb
apt-get update
apt-get install -y zabbix-agent
```









## 优化

### zabbix 页面中文显示异常(如框框)

首先，分析Zabbix自带字体，可以看到经两次链接后，graphfont.ttf实际指向`/usr/share/fonts/dejavu/DejaVuSans.ttf`

```shell
# cat /usr/share/zabbix/include/defines.inc.php |grep -E "*FONT_NAME*"
define('ZBX_GRAPH_FONT_NAME',           'graphfont'); // font file name
define('ZBX_FONT_NAME', 'graphfont');
# ll /usr/share/zabbix/assets/fonts/graphfont.ttf
/usr/share/zabbix/assets/fonts/graphfont.ttf -> /etc/alternatives/zabbix-web-font
# ll /etc/alternatives/zabbix-web-font
/etc/alternatives/zabbix-web-font -> /usr/share/fonts/dejavu/DejaVuSans.ttf
```

从windows系统`C:\Windows\Fonts`拷贝中文字体文件，如：

`simhei.ttf` 黑体常规

`simkai.ttf` 楷体常规

`simfang.ttf` 仿宋常规

重命名为`DejaVuSans.ttf` 替换到对应 zabbix server 上的字体目录。

浏览器刷新即可。

### Zabbix 添加钉钉报警

![1575448237595](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575448237595.png)

群机器人API文档：https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq



https://oapi.dingtalk.com/robot/send?access_token=34398bd41850658d45607d4eb2d2247128b4d3eebcff98d73b35d8abd2c2f4e1



```shell
$ grep alertscripts /etc/zabbix/zabbix_server.conf 
# AlertScriptsPath=${datadir}/zabbix/alertscripts
AlertScriptsPath=/usr/lib/zabbix/alertscripts

$ cat /usr/lib/zabbix/alertscripts/dingding.py 
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import urllib3
import json
import sys
http = urllib3.PoolManager()
token  = "https://oapi.dingtalk.com/robot/send?access_token=34398bd41850658d45607d4eb2d2247128b4d3eebcff98d73b35d8abd2c2f4e1"
head = {'Content-Type':'application/json'}
message = sys.argv[1]
text = '>%s' %(message)
data = {
        "msgtype": "markdown",
        "markdown": {
            "title": "监控小钉报告",
            "text": text
        } 
}
encode_data = json.dumps(data).encode('utf-8')
r = http.request(
        'POST',
        token,
        body = encode_data,
        headers = head
)
# chmod +x /usr/lib/zabbix/alertscripts/dingding.py 
```



动作配置：

![1575449661069](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575449661069.png)



![1575449589621](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575449589621.png)

报警消息内容：

```shell
#### 服务器报警：
#### 告警主机：{HOSTNAME1}
#### 告警IP： {HOST.IP}
#### 告警时间：{EVENT.DATE} {EVENT.TIME}
#### 告警等级：{TRIGGER.SEVERITY}
#### 触发名称： {TRIGGER.NAME}
#### 告警项目：{TRIGGER.KEY1}
#### 问题详情：{ITEM.NAME}：{ITEM.VALUE}
#### 当前状态：{TRIGGER.STATUS}：{ITEM.VALUE1}
#### 事件ID：{EVENT.ID}
```

恢复消息内容：

```shell
#### 服务器恢复：
#### 告警主机：{HOSTNAME1}
#### 告警主机IP：{HOST.IP}
#### 告警时间：{EVENT.DATE} {EVENT.TIME}
#### 告警等级：{TRIGGER.SEVERITY}
#### 告警信息：{TRIGGER.NAME}
#### 告警项目：{TRIGGER.KEY1}
#### 问题详情：{ITEM.NAME}:{ITEM.VALUE}
#### 当前状态：{TRIGGER.STATUS}:{ITEM.VALUE1}
#### 事件ID：{EVENT.ID}
#### 事件状态：{EVENT.STATUS}
```









## 维护

### 监控端口

zabbix 端口监控的几个主要 `keys`：

| Keys                                      | 说明                                                        |
| ----------------------------------------- | ----------------------------------------------------------- |
| net.tcp.listen[port]                      | 监控TCP端口是否在LISTEN，0--not,1--yes                      |
| net.tcp.port[<ip>,port]                   | 检查TCP端口是否可以正常连接。0--not,1--yes，IP默认127.0.0.1 |
| net.tcp.service[service,<ip>,<port>]      | 检查服务是否可用，FTP服务可直接使用FTP模板。                |
| net.tcp.service.perf[service,<ip>,<port>] | 监控服务（端口）连接性能。                                  |
| net.udp.listen[port]                      | 监控UDP端口是否监听。                                       |

通过自动发现实现端口监控：

两个脚本：

1. 端口自动发现 python 实现

   ```shelL
   #!/usr/bin/python
   # -*- coding: utf-8 -*-
   # 使用python2 commands模块
   
   import re
   import commands
   import json
   
   DROP_LIST = ['22','25','111']    # 排除端口
   
   def filterList():
       DROP_str = "|".join(DROP_LIST)
       CMD="sudo netstat -pntl | awk '{print $4,$7}'|grep  [0-9] |egrep -vw '%s'" % (DROP_str)
       Result_Str = commands.getoutput(CMD)
       #print (Result_Str)
       tmp_list = Result_Str.split("\n") #每行加入列表
       new_dict = {}
       for line in tmp_list:
          # print (line)
          PORT_REG = re.search(r"(127.0.0.1:|:::|0.0.0.0:)(\d+).+\d+/(\S+)",line)
          if PORT_REG is not None:
              match_line =  (PORT_REG.groups())
              new_dict[ match_line[-1]]  =  match_line[-2]
       return new_dict
   
   if __name__ == "__main__":
       Results = filterList()
   
       #格式化成适合zabbix lld的json数据
       ports = []
       for key  in  Results:
           ports += [{'{#PNAME}':key,'{#PPORT}':Results[key]}]
       print json.dumps({'data':ports},sort_keys=True,indent=4,separators=(',',':'))
   ```

2. zabbix-agent 配置中添加 key

   `UserParameter=discovery.ports,/usr/bin/python /etc/zabbix/scripts/zabbix_ports_discovery.py`

3. Web端添加自动发现

   添加模板：

   ![1575863906535](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575863906535.png)

   在相应模板添加自动发现规则：

   ![1575864086127](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575864086127.png)

   添加监控项原型：

   ![1575864212524](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1575864212524.png)

   添加触发器：




### Web 监控

1）Web 场景

选择一台测试主机，如：zabbix server -->在"Web 场景"添加

![1576132257236](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576132257236.png)

步骤：

![1576132306480](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576132306480.png)



![1576132437843](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576132437843.png)

2）触发器

![1576132568514](C:\Users\jason\AppData\Roaming\Typora\typora-user-images\1576132568514.png)



# GitLab



## 维护管理

### Webhooks 自动更新

**Webhooks 的实现原理：**

webhooks允许指定一个URL，用于触发push或其他事件时进行自定义操作。

例如，当开发者push代码到GitLab服务器，会触发push事件，GitLab会发送一个POST请求连带数据给webhooks指定的URL，该URL可以是前端web的php程序或Python程序等。这样，每当GitLab有push事件，就能在前端web服务器上执行一个脚本程序。

**Webhooks 实现步骤：**

- 在前端web服务器上安装Git客户端，用于拉取远程仓库 git pull
- 创建并添加公钥，以便免密码拉取远程仓库
- 创建脚本程序，并配置webhooks

















# Scripts



## 实例

### go app 服务管理脚本

```shell
#!/bin/bash

AppDir=/opt/apps/webapi # App目录
App=${AppDir}/main  # App绝对路径
StartCMD="${App} -addr :8088"

function app_start() {
    echo "Starting ${App}......"
    nohup ${StartCMD} >>${AppDir}/log.out 2>&1 &
    echo "Start Finished."
}

function app_stop(){
    echo "Stopping ${App}......"
    kill -9 $(ps -ef |grep "${StartCMD}" |grep -v grep |awk '{print $2}')
    echo "Stop Finished."
}

case $1 in
"start")
app_start
;;
"stop")
app_stop
;;
"restart")
app_stop
sleep 2
app_start
;;
*)
echo "Usage:sh $0 start|stop|restart"
;;
esac

```

### 跳板机部署（nginx+jumpserver+jenkins）

```shell

## 免密认证



## 安装nginx






```





# Network

## 网络排查

### mtr 公网探测工具

```shell
# mtr -n 47.90.89.194
      quit                   Packets               Pings
 Host                  Loss%   Snt   Last   Avg  Best  Wrst StDev
 1. 192.168.1.1         0.0%   132    1.0   1.6   0.5  22.3   2.5
 2. 100.64.0.1          0.0%   132    3.9   5.9   2.1  16.5   2.1
 3. 113.106.38.242      0.0%   132   17.4   9.7   2.2 112.5  14.2
 4. 183.56.65.14        0.0%   132    8.9   8.7   6.0  29.0   2.3
 5. 59.43.80.17         0.0%   132    6.1   9.1   5.8  43.5   3.9
 6. 59.43.18.246        0.0%   132    6.1  11.5   5.3  99.4  14.9
 7. 59.43.130.126      43.9%   132   14.8   9.2   6.6  35.8   4.4
 8. 59.43.187.90       14.5%   132   16.1  18.7   7.8 122.1  13.2
 9. 59.43.183.106       0.8%   132   24.5  23.6  10.1 130.6  16.9
10. 59.43.248.146       0.0%   132   17.7  13.7  11.0  38.7   4.1
11. 203.100.49.214      4.6%   131   11.8  19.1  11.2  54.9   6.8
12. 116.251.87.1        2.3%   131   17.9  26.0  11.3  73.1  11.6
13. 11.16.2.189         2.3%   131   24.8  36.3  15.1 107.0  16.4
14. 11.52.240.21        3.8%   131   17.7  28.2  10.9  48.8   8.8
15. 47.90.89.194        0.0%   131   12.5  13.4  11.8  31.1   2.6
#### 说明 ####
1.到47.90.89.194需要十四跳
2.Packet：
  Loss%(丢包百分比)，Snt(已发送的包数),Last(最后一个发包的延时)
3.Pings:
  Avg(平均延时)，Best(最低延时)，Wrst(最差延时)，StDev(方差，稳定性指标)
```

补充：MTR ，默认使用ICMP协议做mtr，但是因为ICMP报文优先级比较低，有可能会被一部分路由器丢弃，不能探测到真实情况，所以有时还需要使用TCP做mtr。

`mtr -rc www.baidu.com -n --tcp -P 443`

一般在某个IP上，出现严重丢包的点为路劲的Block的点。

**安装：**

centos7:`yum  install mtr -y`

### 实时流量 nethogs



# Shell

## /bin/bash

### 环境变量

Linux 环境变量用户环境变量通常被存储在下面的文件中：

`~/.profile`

`~/.bash_profile` 或者 `~./bash_login`

`~/.bashrc`

系统环境变量：

`/etc/environment`

`/etc/profile`

`/etc/bashrc`

环境变量的优先级：

1. `/etc/profile`：

   在登录时,操作系统定制用户环境时使用的第一个文件,此文件为系统的每个用户设置环境信息,当用户第一次登录时,该文件自动被执行。

2. `/etc/environment`：

   在登录时操作系统使用的第二个文件,系统在读取你自己的profile前,设置环境文件的环境变量。

3. `~/.bash_profile`：

   

## Linux 权限控制

### i 属性文件

i 属性文件不可被修改。

背景：**Linux中的一些病毒,经常会修改,文件的权限为特殊权限,就连root用户也动不了这个 **

使用root用户也提示错误信息：`changing permissions of 'xxx': Operation not permitted；`

命令：

chattr 更改文件属性

​	**添加 i 属性**：`chattr +i /etc/sysctl.conf`

​	**去除 i 属性**：`chattr -i /etc/sysctl.conf`

lsattr 查看文件属性 `lsattr /etc/sysctl.conf `

### Linux ACL 访问控制权限

设置权限：`setfacl`

查看权限：`getfacl`

- 用法：`setfacl [-bkndRLP] { -m|-M|-x|-X ... } file ...`

  -m：修改指定文件或目录当前的ACL

  -M：





## 日志限制

### message报messages lost due to rate-limiting

参考文章：<https://www.rootusers.com/how-to-change-log-rate-limiting-in-linux/>









# 其它杂记

## 



## 远程文件传输

### nc 

示例①.文件拷贝

A：监听端口`nc -l 8089 > filename`

B：传输文件 `nc A_IP 8089 < filename`

示例②.拷贝目录

A：`nc -l 8089 | tar xfvz -`

B：`tar zcvf - * | nc A_IP 8089`

## 文本处理

### 使用ag替代grep

```text
yum install epel-release -y
yum install the_silver_searcher -y
```

用法类似grep，默认已显示行号。



## git

### git usage



查看本地仓库远程地址：`git remote -v`

查看远端所有分支：`git branch -r`



`error: Your local changes to the following files would be overwritten by merge:`

本地文件与远端仓库冲突。

去到指定需强制覆盖目录

`git checkout .`

`git pull`



git reset 本地版本回滚控制（在做代码更新慎用，会覆盖做了忽略的文件，比如：配置文件）

`git reset --hard 96ddfe5`  指定版本回滚

`git reset --hard HEAD~1` 回滚到上一版本



`git rm --cached application/database.php` 指定文件脱离版本控制

`git rm --cached -r public/web` 指定目录脱离版本控制



git rm --cached public/web



解决1.强制覆盖掉本地

#### Linux记住git账号密码

1. 让git读取账密文件 `git config --global credential.helper store`
2. 执行 `git clone` 输入账号密码，



### 错误异常

#### git pull error - fatal: repository 'http://xxx.git/' not found

分析：造成的可能原因①.系统保留其它无权限账号。

```shell
# git config -l
...
credential.helper=store  ## 这里表示使用了凭证存储，
...
## 凭证存储设置
git config --global credential.helper store --file ~/.my-credentials ## 默认~/.git-credentials
## 找到该文件修改里面的用户信息即可。
```

## Firewalld

### 概述



### 使用实例

#### 端口控制

可以通过两种方式控制端口的开放，一种是指定端口号另一种是指定服务名。

```shell
firewall-cmd --add-service=mysql 	# 开放mysql端口
firewall-cmd --remove-service=http  # 阻止http端口
firewall-cmd --list-services 		# 查看开放的服务
firewall-cmd --add-port=3306/tcp 	# 开放通过tcp访问3306
firewall-cmd --remove-port=80tcp 	# 阻止通过tcp访问3306
firewall-cmd --list-ports 			# 查看开放的端口
```

#### 端口转发与 IP 伪装

端口转发可以将指定地址访问指定的端口时，将流量转发至指定地址的指定端口。转发的目的如果不指定 ip 的话就默认为本机，如果指定了 ip 却没指定端口，则默认使用来源端口。

注：端口转发需开启 IP 伪装

```shell
## IP 伪装
firewall-cmd --query-masquerade # 检查是否允许伪装IP
firewall-cmd --add-masquerade # 允许防火墙伪装IP
firewall-cmd --remove-masquerade# 禁止防火墙伪装IP
```

实例：

```shell
firewall-cmd --add-forward-port=port=80:proto=tcp:toport=8080 # 将80端口的流量转发至8080
firewall-cmd --add-forward-port=proto=80:proto=tcp:toaddr=192.168.1.0.1 # 将80端口的流量转发至192.168.0.1
firewall-cmd --add-forward-port=proto=80:proto=tcp:toaddr=192.168.0.1:toport=8080 # 将80端口的流量转发至192.168.0.1的8080端口
```

指定IP指定端口：

```shell
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="120.79.5.18" port protocol="tcp" port="8565" accept"
firewall-cmd --reload
```









## SSL

### 证书申请

#### certbot

Certbot 是一个简单易用的 SSL 证书部署工具，由 EFF 开发，前身即 Let’s Encrypt 官方（Python）客户端。简单来说，certbot 就是一个简化 Let’s Encrypt 部署，和管理 Let’s Encrypt 证书的工具。certbot的开源项目在GitHub上，https://github.com/certbot/certbot

```shell
wget https://dl.eff.org/certbot-auto
chmod a+x certbot-auto
./certbot-auto certonly --standalone --email 邮箱地址 -d 域名1 -d 域名2 ...
## 查看生成的证书
tree /etc/letsencrypt/live/
## 注：Let’s Encrypt 生成的免费证书有效期为3个月
## 证书续签
./certbot-auto renew
```











## Logs

### Logrotate 日志切割

　logrotate软件是一个日志管理工具，用于非分隔日志，删除旧的日志文件，并创建新的日志文件，起到“转储作用”，可以为系统节省磁盘空间。一般centos系统已经自带安装好了。

​    logrotate是基于crontab运行的，其脚本是/etc/cron.daily/logtotate，日志轮转是系统自发完成的，实际运行时，logrotate会调用配置文件/etc/logrotate.conf。可以在/etc/logrotate.d目录里放置自定义好的配置文件，用来覆盖logrotate.conf的缺省值。



**logrotate 切割日志的两种机制：**

1）默认方式：重命名原日志文件，创建新的日志文件。

说明：

1. 重命名只会修改目录文件的内容，而进程操作文件靠的是inode编号，所以并不影响程序继续输出日志。
2. 创建新的日志文件，文件名和原来日志文件一样，但是inode编号不一样，所以程序输出的日志还是往原日志文件输出。
3. 通过某些方式通知程序，重新打开日志文件。程序重新打开日志文件，靠的是文件路径而不是inode编号，所以打开的是新的日志文件。

优点：不会丢失数据。

缺点：需要程序支持重新打开日志的功能，如：可以通过信号通知nginx。还有一种方法重开进程，这种方式会影响在线的服务。

2）copytruncate：把正在输出的日志拷(copy)一份出来，再清空(trucate)原来的日志。

优点：对程序无影响

缺点：日志在拷贝完到清空文件这段时间的写入数据将丢失。

总结：能用create的方案就别用copytruncate，很多程序提供了重开日志文件功能来支持create方案，或者自己做了日志滚动，不依赖logrotate。



**logrotate 配置参数说明：**

| 配置参数               | 参数说明                                               |
| ---------------------- | ------------------------------------------------------ |
| daily\|weekly\|monthly | 转储周期 每天\|每周\|每月                              |
| dateext                | 日志切割文件后缀以当前日期结尾，如：messages-20181125  |
| rotate N               | 日志保留N份                                            |
| compress\|nocompress   | 通过gzip压缩转储日志\|不压缩                           |
| copytruncate           | 拷贝日志文件后截断                                     |
| olddir Dir             | 转储日志存放目录，必须和当前日志文件在同一个文件系统。 |

示例：

```shell
## 系统cron默认调用脚本
#!/bin/sh

/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /home/scripts/logrotate_wallet.conf
EXITVALUE=$?
if [ $EXITVALUE != 0 ]; then
    /usr/bin/logger -t logrotate "ALERT exited abnormally with [$EXITVALUE]"
fi
exit 0

## 钱包服务日志切割
cat /etc/logrotate.d/walletlog
/home/logs/bch/bch.log
/home/logs/btc/btc.log
/home/logs/eos/eos.log
/home/logs/eth/eth.log
/home/logs/ltc/ltc.log
{
daily
copytruncate
dateext
olddir /home/logs/backup
compress
notifempty
rotate 30
}

## 测试
/usr/sbin/logrotate --debug --verbose --force /etc/logrotate.d/walletlog
/usr/sbin/logrotate --force /etc/logrotate.d/walletlog

## tomcat 日志切割
/usr/local/timing/logs/catalina.out
{
daily
copytruncate
dateext
olddir /usr/local/timing/logs/backup
compress
notifempty
rotate 30
}
/usr/sbin/logrotate --force /etc/logrotate.d/timinglog


/var/log/httpd/error_log
/var/log/httpd/access_log
{
daily
copytruncate
dateext
olddir /var/log/httpd/backup
compress
notifempty
rotate 30
}

## 测试

logrotate --debug --verbose --force /var/log/httpd/zabbix
logrotate --force /var/log/httpd/zabbix

## 查看日志切割状态
cat /var/lib/logrotate/logrotate.status
```



## Play

### onion深网

#### yum 安装最新 Tor





#### 编译安装指定版本

这里安装 tor 0.2 最新版本：

https://github.com/torproject/tor/archive/tor-0.2.9.17.tar.gz

参考：

<https://github.com/torproject/tor>

<http://www.uwenku.com/question/p-tekklpju-sg.html>

```shell
## 安装编译环境及相关工具
yum install gcc openssl-devel libevent-devel asciidoc automake wget git -y
## 下载 Tor 源码包
wget https://github.com/torproject/tor/archive/tor-0.2.9.17.tar.gz
sh autogen.sh
./configure --prefix=/data/tor --with-tor-user=tor --with-tor-group=tor
make
make test
make install
mv /data/tor/etc/tor/{torrc.sample,torrc}
echo "HiddenServiceDir /var/lib/tor/hidden_service/" >> /data/tor/etc/tor/torrc
echo "HiddenServicePort 80 127.0.0.1:8080" >>/data/tor/etc/tor/torrc
mkdir -p /var/lib/tor/hidden_service
chmod -R 600 /var/lib/tor
## 配置启动文件
cat > /usr/lib/systemd/system/tor.service <<EOF
[Unit]
Description=Anonymizing overlay network for TCP
After=syslog.target network.target nss-lookup.target

[Service]
Type=forking
PidFile=/var/run/tor/tor.pid
NotifyAccess=all
ExecStartPre=/usr/bin/tor -f /data/tor/etc/tor/torrc --verify-config
ExecStart=/usr/bin/tor -f /data/tor/etc/tor/torrc --RunAsDaemon 1
ExecReload=/bin/kill -HUP ${MAINPID}
KillSignal=SIGINT
TimeoutStartSec=120
TimeoutStopSec=60
Restart=on-failure
LimitNOFILE=65536

# Hardening
PrivateTmp=yes
PrivateDevices=yes
ProtectHome=yes
ProtectSystem=full
ReadOnlyDirectories=/
ReadWriteDirectories=-/var/lib/tor
ReadWriteDirectories=-/var/log/tor
NoNewPrivileges=yes
CapabilityBoundingSet=CAP_SETUID CAP_SETGID CAP_NET_BIND_SERVICE CAP_DAC_OVERRIDE CAP_CHOWN CAP_FOWNER

[Install]
WantedBy=multi-user.target
EOF
systemctl start tor
#### 说明 ####
# 如果启动失败，可以手动启动，看具体报错
# 如：/usr/bin/tor -f /data/tor/etc/tor/torrc --RunAsDaemon 1

```



