
## 分析问题的方法论
套用5W2H方法，可以提出性能分析的几个问题：
- What-现象是什么样的
- When-什么时候发生
- Why-为什么会发生
- Where-哪个地方发生的问题
- How much-耗费了多少资源
- How to do-怎么解决问题

## CPU
### 概述
关注内核CPU调度器功能和性能。
线程状态分析：
- 主要是分析线程的时间用在什么地方
线程状态分类：
- on-CPU：执行中，执行中的时间通常又分为用户态时间user和系统态时间sys。
- off-CPU：等待下一轮上CPU，或者等待I/O、锁、换页等等，其状态可以细分为可执行、匿名换页、睡眠、锁、空闲等状态。

### 相关概念
处理器
核
硬件线程
CPU内存缓存
时钟频率
每指令周期数CPI和每周期指令数IPC
CPU指令
使用率
用户时间／内核时间
调度器
运行队列
抢占
多进程
多线程
字长


### 分析工具

| 工具    | 描述                        |
| ------- | --------------------------- |
| uptime  | 平均负载                    |
| vmstat  | 包括系统范围的cpu平均负载   |
| mpstat  | 查看所有cpu核信息           |
| top     | 监控每个进程cpu用量         |
| sar -u  | 查看cpu信息                 |
| pidstat | 每个进程cpu用量分解         |
| perf    | cpu剖析和跟踪，性能计数分析 |

说明：
- uptime,vmstat,mpstat,top,pidstat只能查询到cpu及负载的的使用情况。
- perf可以跟着到进程内部具体函数耗时情况，并且可以指定内核函数进行统计，指哪打哪。

使用方式：
```shell
# 查看系统cpu使用情况
top

# 查看所有cpu核信息
mpstat -P ALL 1

# 查看cpu使用情况以及平均负载
vmstat 1

# 进程cpu的统计信息
pidstat -u 1 -p pid

# 跟踪进程内部函数级cpu使用情况
perf top -p pid -e cpu-clock
```

## 内存
内存是为提高效率而生，实际分析问题的时候，内存出现问题可能不只是影响性能，而是影响服务或者引起其他问题。
### 相关概念
主存
虚拟内存
常驻内存
地址空间
OOM
页缓存
缺页
换页
交换空间
交换
用户分配器libc、glibc、libmalloc和mtmalloc
LINUX内核级SLUB分配器

### 分析工具

| 工具     | 描述                               |
| -------- | ---------------------------------- |
| free     | 缓存容量统计信息                   |
| vmstat   | 虚拟内存统计信息                   |
| top      | 监视每个进程内存使用情况           |
| pidstat  | 显示活动进程的内存使用统计         |
| pmap     | 查看进程的内存映像信息             |
| sar -r   | 查看内存                           |
| dtrace   | 动态跟踪                           |
| valgrind | 分析程序性能及程序中的内存泄漏错误 |

说明：
- free,vmstat,top,pidstat,pmap只能统计内存信息以及进程的内存使用情况。
- valgrind可以分析内存泄漏问题。
- dtrace动态跟踪。需要对内核函数有很深入的了解，通过D语言编写脚本完成跟踪。


